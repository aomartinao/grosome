# Session Summary — 2026-02-14

## What We Did

### 1. API Key Rotation
- Rotated Anthropic API key used by the `anthropic-proxy` Edge Function
- Updated all 4 rows in `admin_api_keys` table with new key (ending `xgawogAA`)
- Updated `assign_default_api_key()` trigger with the new key
- **Mistake:** A `regexp_replace` to strip whitespace accidentally removed the `s` from `sk-ant-` prefix. Caught by user, fixed manually.

### 2. Egress Investigation & Fixes (8.83 GB for single user)
Root causes found:
- `food_entries` table is 39 MB (17 MB base64 image data in 44 entries)
- Push verification query fetched ALL entries after every sync (`sync.ts:301-311`)
- Pull query used `select('*')` including `image_data` column
- Service Worker update check every 60 seconds

Fixes committed:
- **Removed push verification query** — unnecessary full table scan after every sync
- **Excluded `image_data` from pull** — explicit column list instead of `select('*')`
- **SW update interval 60s → 60min** — `useUpdateAvailable.ts`

### 3. Coach 401 Error — Deep Investigation
The API key was valid (tested directly against Anthropic API → 200 OK), but the coach kept getting 401.

**Root cause chain:**
1. Two users had old **personal** `claude_api_key` in `user_settings` (revoked key ending `A86AAA`)
2. Client logic: `useProxy = !settings.claudeApiKey && settings.hasAdminApiKey` — personal key bypasses proxy
3. Clearing DB didn't help: sync merge logic `localSettings?.claudeApiKey || cloudSettings.claudeApiKey` meant **local wins**
4. Old revoked key in IndexedDB kept being re-synced to cloud on every sync
5. Changed merge to `cloudSettings.claudeApiKey || localSettings?.claudeApiKey` (cloud wins)
6. But `||` still falls through when cloud is `null` — old key STILL came back from IndexedDB
7. **Final fix:** `claudeApiKey: cloudSettings.claudeApiKey` — cloud is authoritative, no local fallback

**Additional DB issues found along the way:**
- `assign_default_api_key()` trigger missing `SET search_path = public, auth` → "Database error saving new user"
- Hardcoded key in trigger was the old revoked one

### 4. Admin Panel
- Deployed to Vercel at `admin-three-silk.vercel.app`
- Fixed `admin_get_user_stats()` — ambiguous `user_id` column, `text` vs `varchar` type mismatch, missing `search_path`
- Fixed `admin_get_user_by_id()` — same issues
- Fixed `addApiKeyForUser()` — parameter name mismatch (`api_key` vs `new_api_key`)
- Added `search_path` to `admin_add_api_key()` and `admin_revoke_api_key()`

### 5. CI Lint Fixes (30 errors → 0)
Errors across ~20 files, fixed by category:
- **Unused imports** — removed from Dashboard, UserDetail, Users (admin)
- **Empty interfaces** — converted to `type` aliases (both `input.tsx` files)
- **react-refresh/only-export-components** — suppressed for UI files exporting component + variants (badge, button, SwipeContext)
- **react-hooks/set-state-in-effect** — suppressed where intentional (ChatInput, TypewriterText, OnboardingGate, GoalSetter, ProteinSpinner)
- **react-hooks/refs** — suppressed for layout positioning reads (CalendarView, WeeklyChart)
- **Component during render** — moved `SectionWrapper` outside `SyncStatus` component
- **useStreak** — converted from `useState + useEffect` to `useMemo` (cleaner, avoids cascading render)
- **useRemainingProtein** — moved `entries || []` inside `useMemo` to avoid unstable reference
- **use-toast.ts** — replaced runtime `actionTypes` const with type-only `ActionTypes`
- **MarkdownText** — removed useless regex escape (`\-` → `-`)
- **UnifiedChat** — suppressed unused `_type` parameter
- **unified.ts** — suppressed `no-explicit-any` for proxy message cast

### 6. Version Bump
- `package.json` 1.0.0 → 1.0.1

---

## Commits (in order)
1. Egress fixes (removed verification query, excluded image_data, SW interval)
2. Sync merge priority fix (cloud wins for claudeApiKey — first attempt with `||`)
3. `assign_default_api_key()` search_path + key update
4. Admin panel parameter name fix (`api_key` → `new_api_key`)
5. Version bump to 1.0.1
6. `fix: resolve all 30 ESLint errors blocking CI` (`4ce7b1e`)
7. `fix: prevent revoked API key from resurfacing via sync merge` (`736d41c`) — final fix, cloud authoritative

---

## Database Changes (NOT in code/migrations)
These were applied directly via psql and are not tracked in migration files:

| Function/Table | Change |
|---|---|
| `admin_api_keys` | All 4 rows updated with new key |
| `user_settings` | `claude_api_key` set to NULL for all users |
| `assign_default_api_key()` | New key + `SET search_path = public, auth` |
| `admin_get_user_stats()` | Recreated with table aliases, `varchar` type, `search_path` |
| `admin_get_user_by_id()` | Same fixes |
| `admin_add_api_key()` | Added `SET search_path = public, auth` |
| `admin_revoke_api_key()` | Added `SET search_path = public, auth` |

**Risk:** These changes are not in version control. If the DB is recreated from migrations, they'll be lost.

---

## Lessons Learned

### 1. `||` doesn't mean "cloud wins" for nullable fields
`cloudValue || localValue` falls through when cloud is `null`, `undefined`, `0`, or `''`. For fields where cloud should be authoritative (especially cleared/revoked credentials), use direct assignment: `cloudValue` — not a fallback chain.

### 2. Regex operations on secrets are dangerous
A blanket `regexp_replace` to strip whitespace matched characters in the key prefix (`sk-ant-`). Never apply regex to secrets — validate format first, then trim only leading/trailing whitespace with a targeted approach.

### 3. IndexedDB is a persistent source of stale data
Even after clearing the cloud DB, the old value syncs back from IndexedDB on the next sync cycle. The merge strategy must account for "cloud explicitly cleared this value" vs "cloud never had this value."

### 4. Supabase functions need `SET search_path`
`SECURITY DEFINER` functions in Supabase need `SET search_path = public, auth` to resolve tables correctly. Without it, functions can't find tables and silently fail or error.

### 5. ESLint rule names matter for disable comments
`react-hooks/set-state-in-effect` only fires on the FIRST `setState` in an effect — subsequent calls in the same effect don't trigger it. And `react-hooks/refs` is the correct rule name, not `react-compiler/react-compiler`.

### 6. Base64 images in DB cause massive egress
44 food entries with base64 `image_data` = 17 MB in the table. With `select('*')` on every sync + a redundant verification query, this adds up fast (8.83 GB egress for one user).

### 7. Dual API key system complexity
The personal key → proxy bypass → revoked key loop was hard to debug because it involved: client logic (useProxy check), IndexedDB (cached settings), sync merge strategy, cloud DB state, and the edge function — all interacting. Simplifying to "cloud is authoritative for API keys" eliminated the entire class of bugs.
